<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบจัดการงานส่วนกลาง</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <!-- Custom CSS -->
  <style>
    /* Toast Notification */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 9999;
      top: 20px;
      right: 20px;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.5s ease, visibility 0.5s ease;
      pointer-events: none;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
    }

    /* ตารางติ๊กงาน */
    .done {
      background-color: #198754;
    }

    .notdone {
      background-color: #dc3545;
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

  <div class="container py-5">
    <h1 class="mb-4 text-center">ระบบจัดการงานส่วนกลาง</h1>

    <div class="card shadow-sm mb-4 p-4">
      <form id="taskForm" class="row g-3 align-items-center">
        <div class="col-md-4">
          <label for="workDate" class="form-label">เลือกวันที่</label>
          <input type="date" id="workDate" class="form-control" />
        </div>
        <div class="col-md-4">
          <label for="employeeSelect" class="form-label">ชื่อ</label>
          <select id="employeeSelect" class="form-select">
            <option value="">-- ชื่อ --</option>
            <option value="ดา">ดา</option>
            <option value="บีม">บีม</option>
            <option value="เมย์">เมย์</option>
          </select>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button type="button" id="saveBtn" class="btn btn-primary flex-grow-1">บันทึกงาน</button>
          <button type="button" id="goSummaryBtn" class="btn btn-outline-secondary flex-grow-1">สรุปงานวันนี้</button>
          <button type="button" id="goHistoryBtn" class="btn btn-outline-info flex-grow-1">ดูย้อนหลัง</button>
        </div>

        <div class="col-12 mt-3">
          <p class="text-muted mb-2">ติ๊กงานที่ทำเสร็จแล้ว</p>
          <div class="row row-cols-2 row-cols-md-3 g-3" id="taskList">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ตึกเฮงๆ" id="task1" />
              <label class="form-check-label" for="task1">ตึกเฮงๆ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ข้างเฮงๆ" id="task2" />
              <label class="form-check-label" for="task2">ข้างเฮงๆ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ตึกซัก" id="task3" />
              <label class="form-check-label" for="task3">ตึกซัก</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="บ้าน 21" id="task4" />
              <label class="form-check-label" for="task4">บ้าน 21</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="บ้าน 49" id="task5" />
              <label class="form-check-label" for="task5">บ้าน 49</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="บ้าน 259" id="task6" />
              <label class="form-check-label" for="task6">บ้าน 259</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="เก็บขอบบัว+เช็ดประตู" id="task7" />
              <label class="form-check-label" for="task7">เก็บขอบบัว+เช็ดประตู</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ร้านเฮงๆ+พื้นที่ข้างหน้า" id="task8" />
              <label class="form-check-label" for="task8">ร้านเฮงๆ+พื้นที่ข้างหน้า</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ห้องเก็บของ(ข้างเฮงๆ)+เครื่องซักผ้าข้างหน้า"
                id="task9" />
              <label class="form-check-label" for="task9">ห้องเก็บของ(ข้างเฮงๆ)+เครื่องซักผ้าข้างหน้า</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="รดน้ำต้นไม้" id="task10" />
              <label class="form-check-label" for="task10">รดน้ำต้นไม้</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="เคาน์เตอร์หน้าร้านซัก" id="task11" />
              <label class="form-check-label" for="task11">เคาน์เตอร์หน้าร้านซัก</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ห้องซัก" id="task12" />
              <label class="form-check-label" for="task12">ห้องซัก</label>
            </div>
          </div>
        </div>
      </form>

      <p class="text-muted mt-3 mb-0">ข้อมูลถูกเก็บใน Local Storage (แยกตามวัน)</p>
    </div>

    <h2 id="individualTitle" class="mb-3">งานของแต่ละคน</h2>
    <div id="individualContainer" class="d-flex flex-wrap gap-3 mb-5"></div>

    <h2 id="summaryTitle" class="mb-3">ตารางสรุปงานของวันที่เลือก</h2>
    <div id="summaryContainer" class="table-responsive mb-5"></div>

    <h2 id="yesterdayTitle" class="mb-3">ตารางสรุปงานของเมื่อวาน</h2>
    <div id="yesterdaySummaryContainer" class="table-responsive"></div>
  </div>

  <!-- Bootstrap 5 JS Bundle (Popper + JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function toLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDfUd3RdyccN4_u0R6bNbYtejHFYUNPxkM",
      authDomain: "shop2-eba1e.firebaseapp.com",
      projectId: "shop2-eba1e",
      storageBucket: "shop2-eba1e.appspot.com",
      messagingSenderId: "1016144050614",
      appId: "1:1016144050614:web:0f898db4bb56084121a917",
      measurementId: "G-RHD6SC5NF0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tasksAll = [
      "ตึกเฮงๆ",
      "ข้างเฮงๆ",
      "ตึกซัก",
      "บ้าน 21",
      "บ้าน 49",
      "บ้าน 259",
      "เก็บขอบบัว+เช็ดประตู",
      "ร้านเฮงๆ+พื้นที่ข้างหน้า",
      "ห้องเก็บของ(ข้างเฮงๆ)+เครื่องซักผ้าข้างหน้า",
      "รดน้ำต้นไม้",
      "เคาน์เตอร์หน้าร้านซัก",
      "ห้องซัก",
    ];

    function loadData() {
      const raw = localStorage.getItem('workData');
      return raw ? JSON.parse(raw) : {};
    }

    function saveData(obj) {
      localStorage.setItem('workData', JSON.stringify(obj));
    }

    const dateInput = document.getElementById('workDate');
    const employeeSelect = document.getElementById('employeeSelect');
    const checkboxes = document.querySelectorAll('#taskList input[type="checkbox"]');
    const saveBtn = document.getElementById('saveBtn');
    const goSummaryBtn = document.getElementById('goSummaryBtn');
    const goHistoryBtn = document.getElementById('goHistoryBtn');
    const individualContainer = document.getElementById('individualContainer');
    const summaryContainer = document.getElementById('summaryContainer');
    const yesterdaySummaryContainer = document.getElementById('yesterdaySummaryContainer');

    function getLocalDateISO() {
      return toLocalDateString(new Date());
    }

    function formatThaiDate(date) {
      const day = date.getDate();
      const monthNames = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
        "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
      ];
      const month = monthNames[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    dateInput.value = getLocalDateISO();

    // ตัวแปรเก็บฟังก์ชันยกเลิก listener
    let unsubscribe = null;

    function listenToWorkData(day) {
      if (unsubscribe) unsubscribe(); // ยกเลิก listener เดิมก่อนถ้ามี

      unsubscribe = db.collection('workData').doc(day)
        .onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            // อัปเดต localStorage ด้วยข้อมูลจาก Firebase
            const localData = loadData();
            localData[day] = data;
            saveData(localData);

            // รีเรนเดอร์ UI ด้วยข้อมูลใหม่
            renderIndividualTables();
            renderSummaryTable();
            renderYesterdaySummaryTable();
            updateSummaryTitles();

            // อัปเดต checkbox ของพนักงานที่เลือก (ถ้ามี)
            const employee = employeeSelect.value;
            if (employee && data[employee]) {
              const doneTasks = data[employee];
              checkboxes.forEach(cb => {
                cb.checked = doneTasks.includes(cb.value);
              });
            }
          }
        });
    }

    function deleteEmployeeData(emp) {
      const data = loadData();
      const day = dateInput.value;

      if (data[day] && data[day][emp]) {
        delete data[day][emp];
        saveData(data);
        db.collection('workData').doc(day).update({
          [emp]: firebase.firestore.FieldValue.delete()
        }).catch(() => { });

        renderIndividualTables();
        renderSummaryTable();
        renderYesterdaySummaryTable();
        updateSummaryTitles();
      }
    }

    function renderIndividualTables() {
      const data = loadData();
      const day = dateInput.value;
      const todayData = data[day] || {};

      const employees = ['ดา', 'บีม', 'เมย์'];
      individualContainer.innerHTML = '';

      employees.forEach(emp => {
        const tasks = todayData[emp] || [];

        const card = document.createElement('div');
        card.className = 'card card-small p-3 flex-grow-1 shadow-sm';

        let html = `
          <h5>${emp}</h5>
          <button class="btn btn-danger btn-sm small-btn mb-2" onclick="deleteEmployeeData('${emp}')">ลบข้อมูลของ ${emp}</button>
          <table class="table table-bordered mb-0">
            <thead class="table-light"><tr><th>งานที่ทำ</th></tr></thead>
            <tbody>
        `;

        if (tasks.length === 0) {
          html += `<tr><td class="text-muted">ยังไม่มีข้อมูล</td></tr>`;
        } else {
          tasks.forEach(t => html += `<tr><td>${t}</td></tr>`);
        }

        html += `</tbody></table>`;
        card.innerHTML = html;
        individualContainer.appendChild(card);
      });
    }

    function renderSummaryTable() {
      const data = loadData();
      const day = dateInput.value;
      const todayData = data[day] || {};
      const employees = ['ดา', 'บีม', 'เมย์'];

      let html = `<table class="table table-striped table-bordered text-center align-middle shadow-sm summary-table">
        <thead class="table-dark">
          <tr>
            <th>งาน</th>
            ${employees.map(e => `<th>${e}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
      `;

      tasksAll.forEach(task => {
        html += `<tr><td class="text-start">${task}</td>`;
        employees.forEach(emp => {
          const doneTasks = todayData[emp] || [];
          if (doneTasks.includes(task)) {
            html += `<td class="done"></td>`;
          } else {
            html += `<td class="notdone"></td>`;
          }
        });
        html += `</tr>`;
      });

      html += `</tbody></table>`;

      summaryContainer.innerHTML = html;
    }

    function renderYesterdaySummaryTable() {
      const data = loadData();
      const selectedDate = new Date(dateInput.value);
      const yesterdayDate = new Date(selectedDate);
      yesterdayDate.setDate(selectedDate.getDate() - 1);

      const yesterdayKey = toLocalDateString(yesterdayDate);

      const yesterdayData = data[yesterdayKey] || {};
      const employees = ['ดา', 'บีม', 'เมย์'];

      let html = `<table class="table table-striped table-bordered text-center align-middle shadow-sm summary-table">
        <thead class="table-dark">
          <tr>
            <th>งาน</th>
            ${employees.map(e => `<th>${e}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
      `;

      tasksAll.forEach(task => {
        html += `<tr><td class="text-start">${task}</td>`;
        employees.forEach(emp => {
          const doneTasks = yesterdayData[emp] || [];
          if (doneTasks.includes(task)) {
            html += `<td class="done"></td>`;
          } else {
            html += `<td class="notdone"></td>`;
          }
        });
        html += `</tr>`;
      });

      html += `</tbody></table>`;

      yesterdaySummaryContainer.innerHTML = html;
    }

    function updateSummaryTitles() {
      const selectedDate = new Date(dateInput.value);
      const yesterdayDate = new Date(selectedDate);
      yesterdayDate.setDate(selectedDate.getDate() - 1);

      document.getElementById('summaryTitle').textContent = `ตารางสรุปงานวันนี้ ${formatThaiDate(selectedDate)}`;
      document.getElementById('yesterdayTitle').textContent = `ตารางสรุปงานเมื่อวาน (${formatThaiDate(yesterdayDate)})`;
    }

    function showToast(message, bgColor = '#198754') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.backgroundColor = bgColor;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    async function saveTasks() {
      const employee = employeeSelect.value;
      const day = dateInput.value;

      if (!day) {
        showToast("เลือกวันที่", '#dc3545');
        return;
      }
      if (!employee) {
        showToast("เลือกชื่อ", '#dc3545');
        return;
      }

      const done = [];
      checkboxes.forEach(cb => {
        if (cb.checked) done.push(cb.value);
      });

      const d = loadData();
      if (!d[day]) d[day] = {};
      d[day][employee] = done;
      saveData(d);

      try {
        const docRef = db.collection('workData').doc(day);
        await docRef.set({ [employee]: done }, { merge: true });
      } catch (error) {
        console.error("Error writing document: ", error);
      }

      // ไม่ต้องรีเรนเดอร์ตรงนี้ เพราะ listener จะทำให้รีเรนเดอร์เอง

      showToast("บันทึกงานเรียบร้อยแล้ว", '#198754');
    }

    async function saveTasksAuto() {
      const employee = employeeSelect.value;
      const day = dateInput.value;

      if (!day || !employee) return;

      const done = [];
      checkboxes.forEach(cb => {
        if (cb.checked) done.push(cb.value);
      });

      const d = loadData();
      if (!d[day]) d[day] = {};
      d[day][employee] = done;
      saveData(d);

      try {
        const docRef = db.collection('workData').doc(day);
        await docRef.set({ [employee]: done }, { merge: true });
      } catch (error) {
        console.error("Error writing document: ", error);
      }

      // ไม่ต้องรีเรนเดอร์ตรงนี้ เพราะ listener จะทำให้รีเรนเดอร์เอง
    }

    window.addEventListener('DOMContentLoaded', () => {
      listenToWorkData(dateInput.value);
      updateSummaryTitles();
    });

    dateInput.addEventListener('change', () => {
      listenToWorkData(dateInput.value);
      updateSummaryTitles();
    });

    employeeSelect.addEventListener('change', () => {
      const employee = employeeSelect.value;
      const day = dateInput.value;

      // โหลดข้อมูลมาเช็คบ็อกซ์อัตโนมัติ จาก localStorage
      const data = loadData();
      const doneTasks = (data[day] && data[day][employee]) || [];
      checkboxes.forEach(cb => {
        cb.checked = doneTasks.includes(cb.value);
      });
    });

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        saveTasksAuto();
      });
    });

    saveBtn.addEventListener('click', () => {
      saveTasks();
    });

    goSummaryBtn.addEventListener('click', () => {
      const summaryTitle = document.getElementById('summaryTitle');
      if (summaryTitle) {
        summaryTitle.scrollIntoView({ behavior: 'smooth' });
      }
    });

    goHistoryBtn.addEventListener('click', () => {
      const day = dateInput.value;
      if (!day) {
        showToast("เลือกวันที่ก่อน", '#dc3545');
        return;
      }
      window.location.href = `summary.html?date=${day}`;
    });

  </script>

  <!-- Toast -->
  <div id="toast"></div>

</body>

</html>
